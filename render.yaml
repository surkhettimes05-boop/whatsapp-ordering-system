services:
  # ============================================================
  # PostgreSQL Database - Production Configuration
  # ============================================================
  - type: pserv
    name: whatsapp-postgres
    runtime: image
    image:
      fromRegistry:
        url: docker.io/library/postgres:15-alpine
    env:
      - key: POSTGRES_USER
        value: postgres
      - key: POSTGRES_PASSWORD
        generateValue: true
      - key: POSTGRES_DB
        value: whatsapp_ordering
      - key: POSTGRES_INITDB_ARGS
        value: "-c max_connections=100 -c shared_buffers=256MB"
    disk:
      name: postgres-data
      mountPath: /var/lib/postgresql/data
      sizeGB: 20
    healthCheck:
      path: /health
    previewPlan: free

  # ============================================================
  # Redis Cache & Message Queue - Production Configuration
  # ============================================================
  - type: pserv
    name: whatsapp-redis
    runtime: image
    image:
      fromRegistry:
        url: docker.io/library/redis:7-alpine
    env:
      - key: REDIS_ARGS
        value: "--appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru"
    disk:
      name: redis-data
      mountPath: /data
      sizeGB: 10
    previewPlan: free

  # ============================================================
  # Backend API - Production Configuration
  # ============================================================
  - type: web
    name: whatsapp-backend
    runtime: node
    
    # Build configuration - CRITICAL for Prisma
    buildCommand: |
      echo "ðŸ“¦ Installing dependencies..."
      npm ci
      echo "âœ… Dependencies installed"
      
      echo "ðŸ”§ Generating Prisma Client..."
      npx prisma generate
      echo "âœ… Prisma Client generated"
      
      echo "ðŸ”„ Running database migrations..."
      npx prisma migrate deploy
      echo "âœ… Migrations completed"
    
    # Start command - runs from backend directory
    startCommand: cd backend && npm run render-start
    
    # Environment Variables - Use env reference for database connection
    envVars:
      - key: NODE_ENV
        value: production
      
      - key: PORT
        value: "5000"
      
      - key: DOMAIN
        sync: false  # Must be set in dashboard
      
      # Database connection - auto-generated by Render
      - key: DATABASE_URL
        fromService:
          type: pserv
          name: whatsapp-postgres
          property: connectionString
      
      # Redis connection
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: whatsapp-redis
          property: host
      
      - key: REDIS_PORT
        value: "6379"
      
      # JWT Configuration
      - key: JWT_SECRET
        generateValue: true
      
      - key: JWT_EXPIRES_IN
        value: "30d"
      
      # Twilio WhatsApp Integration (REQUIRED - set in dashboard)
      - key: TWILIO_ACCOUNT_SID
        sync: false
      
      - key: TWILIO_AUTH_TOKEN
        sync: false
      
      - key: TWILIO_PHONE_NUMBER
        sync: false
      
      - key: TWILIO_WHATSAPP_NUMBER
        sync: false
      
      # Webhook URL (set after deployment)
      - key: WEBHOOK_URL
        sync: false
      
      # Admin Setup (set in dashboard)
      - key: ADMIN_EMAIL
        sync: false
      
      - key: ADMIN_PASSWORD
        sync: false
      
      # Logging
      - key: LOG_LEVEL
        value: info
      
      # Optional: App version tracking
      - key: APP_VERSION
        value: "1.0.0"
    
    # Root directory where package.json is located
    rootDir: ./backend
    
    # Health check configuration - CRITICAL
    healthCheckPath: /health
    healthCheckInterval: 60  # Check every 60 seconds
    
    # Auto-deploy settings
    autoDeploy: true
    
    # Service dependencies
    dependsOn:
      - whatsapp-postgres
      - whatsapp-redis
    
    # Resource configuration
    plan: standard
    numInstances: 1
    
    # Timeout settings (Render default: 30s)
    # Webhook responses must complete within 5s
    
    # Scale up based on CPU/memory if needed
    autoscaling:
      cpu:
        percentage: 80
      memory:
        percentage: 80
      maxInstances: 3
      minInstances: 1

  # ============================================================
  # Frontend Dashboard - Static Build
  # ============================================================
  - type: web
    name: whatsapp-frontend
    runtime: static
    buildCommand: |
      echo "ðŸ“¦ Installing dependencies..."
      cd frontend && npm ci
      echo "âœ… Dependencies installed"
      
      echo "ðŸ”¨ Building React app..."
      npm run build
      echo "âœ… Build completed"
    
    staticPublishPath: ./frontend/dist
    
    # Redirect all routes to index.html for SPA
    routes:
      - pattern: /
        destination: /
      - pattern: /api/*
        destination: https://whatsapp-backend-xxx.onrender.com/api/$1
    
    # Environment for frontend build
    envVars:
      - key: VITE_API_BASE_URL
        fromService:
          type: web
          name: whatsapp-backend
          property: url
    
    autoDeploy: true
    plan: free  # Static sites can use free tier

# ============================================================
# Cron Jobs for Background Tasks (Optional)
# ============================================================
# You can add scheduled jobs using Render's scheduler:
# - Daily reconciliation
# - Order cleanup
# - Vendor notifications
# (Configure in Render dashboard under "Background Workers")

