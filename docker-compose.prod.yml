version: '3.9'

services:
  # ========================================================================
  # PostgreSQL Database - Primary data store
  # ========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: whatsapp-postgres-prod
    restart: unless-stopped
    
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-whatsapp_ordering}
      # Performance tuning for production
      POSTGRES_INITDB_ARGS: >-
        -c max_connections=200
        -c shared_buffers=256MB
        -c effective_cache_size=1GB
        -c work_mem=4MB
        -c maintenance_work_mem=64MB
        -c random_page_cost=1.1
        -c effective_io_concurrency=200
        -c synchronous_commit=on
        -c wal_buffers=16MB
        -c default_statistics_target=100
        -c checkpoint_completion_target=0.9
        -c wal_compression=on
        -c min_wal_size=1GB
        -c max_wal_size=4GB
    
    ports:
      - "5432:5432"
    
    volumes:
      # Persistent database storage
      - postgres_data:/var/lib/postgresql/data:delegated
      # Backup volume
      - postgres_backups:/backups
      # Custom init scripts
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    
    healthcheck:
      test: 
        - CMD-SHELL
        - |
          pg_isready -U ${DB_USER:-postgres} && \
          psql -U ${DB_USER:-postgres} -d ${DB_NAME:-whatsapp_ordering} -c "SELECT 1" > /dev/null 2>&1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    
    networks:
      - app-network
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================================================
  # Redis - Cache & BullMQ Job Queue
  # ========================================================================
  redis:
    image: redis:7-alpine
    container_name: whatsapp-redis-prod
    restart: unless-stopped
    
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-redis_password}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --appendonly yes
      --appendfsync everysec
      --loglevel notice
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
    
    ports:
      - "6379:6379"
    
    volumes:
      # Persistent Redis data
      - redis_data:/data:delegated
    
    healthcheck:
      test: 
        - CMD
        - redis-cli
        - -a
        - ${REDIS_PASSWORD:-redis_password}
        - ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    networks:
      - app-network
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================================================
  # Node.js Backend Application
  # ========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
      args:
        NODE_ENV: production
    
    container_name: whatsapp-app-prod
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    environment:
      # Core
      NODE_ENV: production
      PORT: 5000
      APP_VERSION: 1.0.0
      
      # Database
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@postgres:5432/${DB_NAME:-whatsapp_ordering}?sslmode=disable&schema=public
      
      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      
      # Security
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: 7d
      FORCE_TWILIO_VERIFY: 'true'
      
      # Twilio Integration
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_WHATSAPP_FROM: ${TWILIO_WHATSAPP_FROM}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER}
      
      # Logging
      LOG_LEVEL: info
      LOG_FORMAT: json
      
      # OpenAI (if used)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      
      # Email (if used)
      EMAIL_FROM: ${EMAIL_FROM:-noreply@company.com}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      
      # Slack (if used for alerts)
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      ALERT_EMAIL: ${ALERT_EMAIL:-}
      
      # Performance & Monitoring
      NODE_OPTIONS: "--max-old-space-size=512 --enable-source-maps"
    
    ports:
      - "5000:5000"
    
    volumes:
      # Persistent logs
      - ./logs:/app/logs:delegated
      # Upload directory
      - ./uploads:/app/uploads:delegated
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    
    networks:
      - app-network
    
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=whatsapp-app"

# ============================================================================
# Volumes for persistent data
# ============================================================================
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_DATA_PATH:-./data/postgres}
  
  postgres_backups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_BACKUPS_PATH:-./data/backups}
  
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${REDIS_DATA_PATH:-./data/redis}

# ============================================================================
# Networks
# ============================================================================
networks:
  app-network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450
    ipam:
      config:
        - subnet: 172.28.0.0/16
